From 8280f0f92436a6e405508be20ac2046a46d39cfb Mon Sep 17 00:00:00 2001
From: Patrick Monnerat <patrick@monnerat.net>
Date: Tue, 28 Mar 2023 13:15:04 +0800
Subject: [PATCH] content_encoding: do not reset stage counter for each header

Test 418 verifies

Closes #10492

CVE: CVE-2023-23916

Upstream-Status: Backport [https://github.com/curl/curl/commit/119fb187192a9ea13dc90d9d20c215fc82799ab9]

Signed-off-by: Mingli Yu <mingli.yu@windriver.com>
---
 lib/content_encoding.c | 7 +++----
 lib/urldata.h          | 1 +
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/lib/content_encoding.c b/lib/content_encoding.c
index 6f994b3..29dc660 100644
--- a/lib/content_encoding.c
+++ b/lib/content_encoding.c
@@ -1035,7 +1035,6 @@ CURLcode Curl_build_unencoding_stack(struct Curl_easy *data,
                                      const char *enclist, int maybechunked)
 {
   struct SingleRequest *k = &data->req;
-  int counter = 0;
 
   do {
     const char *name;
@@ -1070,9 +1069,9 @@ CURLcode Curl_build_unencoding_stack(struct Curl_easy *data,
       if(!encoding)
         encoding = &error_encoding;  /* Defer error at stack use. */
 
-      if(++counter >= MAX_ENCODE_STACK) {
-        failf(data, "Reject response due to %u content encodings",
-              counter);
+      if(k->writer_stack_depth++ >= MAX_ENCODE_STACK) {
+        failf(data, "Reject response due to more than %u content encodings",
+              MAX_ENCODE_STACK);
         return CURLE_BAD_CONTENT_ENCODING;
       }
       /* Stack the unencoding stage. */
diff --git a/lib/urldata.h b/lib/urldata.h
index 1ffde55..69eb2ee 100644
--- a/lib/urldata.h
+++ b/lib/urldata.h
@@ -708,6 +708,7 @@ struct SingleRequest {
   struct dohdata *doh; /* DoH specific data for this request */
 #endif
   unsigned char setcookies;
+  unsigned char writer_stack_depth; /* Unencoding stack depth. */
   BIT(header);        /* incoming data has HTTP header */
   BIT(content_range); /* set TRUE if Content-Range: was found */
   BIT(upload_done);   /* set to TRUE when doing chunked transfer-encoding
-- 
2.25.1

